# 项目 TODO LIST（6 周）
**项目**：基于多层次校准与贝叶斯代理模型的公交仿真参数鲁棒反演研究  
**English**：Robust Inversion of Bus Simulation Parameters Based on Multi-level Calibration and Bayesian Surrogate Models  
**仿真平台**：SUMO（建议安装路径：`D:\SUMO`）  

> 使用方式：每完成一项勾选 `[x]`；在每周末补充“产出物/结论/问题清单”，保证可追溯。

---

## 全周期里程碑（Week 1–6）
- [x] Week 1：基础环境搭建（SUMO 场景 + TraCI + 香港真值提取/清洗）
- [x] Week 2：L1 微观层校准最小闭环（参数采样 + 单代理 BO + 基础时刻对齐指标）
- [ ] Week 3：L1 微观层校准完善（双代理 Kriging+RBF 融合 + 鲁棒分布指标 + 验证/消融）
- [ ] Week 4：L2 宏观层融合（EnKF/同化模块 + 路段速度分布匹配）
- [ ] Week 5：对比实验与鲁棒性评估（K-S 检验、不同拥堵情景、敏感性分析）
- [ ] Week 6：论文/报告交付（方法复现细节、实验结果、可复用代码与说明）

---

## 论文写作“稳过型”5 个硬指标（贯穿 Week 2–6）
> 目标：把论文写成“工程可复现 + 贡献分层清晰 + 对比扎实 + 鲁棒可量化 + 成本说得透”的 ICTLE 口味。

### 1）分层贡献（必须做消融）
- [ ] 明确三组：`L1-only`、`L2-only`、`L1+L2`（同一数据划分、同一预算口径）
- [ ] 统一输出：`J1/J2/J` 收敛曲线 + 测试期指标表（mean/median/P90/worst/K-S）

### 2）强基线（至少 3 个，口径一致）
- [ ] B1：人工经验/默认参数（作为工程基线）
- [ ] B2：单层校准（只对齐 `J1` 或只对齐 `J2`）
- [ ] B3：黑箱优化 GA/PSO（同预算对比）
- [ ] 可选 B4：单代理 BO（只有 Kriging 或只有 RBF）

### 3）两类观测同时对齐（L1 + L2 同时成立）
- [ ] L1：站点到/离站时刻、站间行程时间、停站时长分布（CDF/分位误差）
- [ ] L2：路段速度分布（CDF/分位误差）+ 时空速度图（time–space diagram）

### 4）鲁棒性可证明（不是口号）
- [ ] 跨时段/跨日验证：训练期 vs 测试期（至少 2 天训 + 1 天测，或按时段划分）
- [ ] 分布一致性：K-S 检验统计量（或 p-value 口径固定其一）+ 分位数误差（P50/P90/P95）
- [ ] Worst-case 报告：按时段/日期取最差表现，给出 `worst-case` 指标

### 5）计算成本说透（工程效率叙事）
- [ ] 报告总仿真次数、墙钟耗时、单次仿真耗时、并行策略与硬件信息
- [ ] 收敛曲线：迭代次数 vs 最优值下降（`J/J1/J2`），并给“提升 1% 精度的仿真预算”统计
- [ ] 基线预算对齐：所有方法使用相同仿真预算/终止条件（避免不公平）

---

## Week 1（基础环境搭建）— 详细步骤

### 1）工作区与版本化（可追溯）
- [x] 建议建立目录骨架（后续脚本都按此约定放置）
  - [x] `docs/`：调研摘记、接口说明、实验记录
  - [x] `data/raw/`：高德原始响应（按日期/线路分文件）
  - [x] `data/processed/`：清洗后的真值（CSV/Parquet）
  - [x] `sumo/net/`：路网（`*.net.xml`）
  - [x] `sumo/additional/`：站点、检测器等附加文件
  - [x] `sumo/routes/`：线路与车辆（`*.rou.xml`）
  - [x] `sumo/config/`：`*.sumocfg`
  - [x] `src/`：核心代码（采集/清洗/校准/评估）
  - [x] `scripts/`：一次性工具脚本（下载、转换、批处理）
- [x] 建立实验记录模板（建议在 `docs/experiments.md` 里按日期记录）
  - [x] 本周选择的线路/方向/时间窗
  - [x] 数据来源与采样频率、缺失情况
  - [x] SUMO 场景版本、关键参数默认值
  - [x] 运行截图/日志路径与复现实验命令

### 2）SUMO 与 Python 环境（能跑、可复现）
- [x] 安装并验证 SUMO（建议：`D:\SUMO`）
  - [x] `sumo`, `sumo-gui`, `netconvert` 可在命令行运行
  - [x] 设置环境变量 `SUMO_HOME=D:\SUMO`，并将 `%SUMO_HOME%\\bin` 加入 `PATH`
- [x] Python 虚拟环境（建议 3.10+）
  - [x] 安装依赖：数据处理（`pandas/numpy`）、可视化（`matplotlib`）、统计（`scipy`）
  - [x] 校准/代理：`scikit-learn`（RBF 等）、Kriging/GP（确定库后固定版本）
  - [x] SUMO 接口：确保 `traci` 可导入（通常来自 `SUMO_HOME/tools`）
- [x] 最小 TraCI 冒烟测试
  - [x] 运行一个最小示例场景（1 条边、1 辆车），验证能取到 `speed/pos/edge` 等基本量
  - [x] 记录本机 SUMO 版本号与 Python 版本号到 `docs/experiments.md`

### 3）目标线路 SUMO 场景建模（先能对齐“站点”）
- [x] 明确研究对象
  - [x] 选定线路/时段：68X（基线稳态）+ 960（过海复杂工况），双向，时窗 2025-12-17 17:35–18:35，首轮测试数据已收集。
  - [x] 列出站点序列、站间距离、首末站信息（从 KMB `/route-stop` + GeoJSON 形状累积里程获取）
- [x] 路网准备
  - [x] Path A：OSM/公开路网 → `netconvert` 生成 `*.net.xml`
- [x] 公交站点与线路文件
  - [x] 在 `sumo/additional/` 生成公交站点（`busStop`）并绑定到 lane
  - [x] 在 `sumo/routes/` 建立线路 route 与车辆 flows（先用少量车辆验证）
- [x] 运行基线仿真并产出“站点层”日志
  - [x] 至少能导出：到站/离站时刻、停站时间、站间运行时间
  - [x] 保存：`sumo/config/*.sumocfg`、仿真输出（tripinfo/stopinfo 等）

### 4）真值数据提取（站点时刻 + 路况速度）— 改为香港 KMB/LWB + data.gov.hk
- [x] 明确 API 需求与字段映射（在 `docs/gaode_schema.md` 记录）
  - [x] 线路/站点：KMB/LWB `/route`、`/stop`、`/route-stop`；政府 GeoJSON（Routes and fares）获取 polyline/沿线里程
  - [x] 到离站/ETA：KMB ETA `/eta` 或 `/route-eta` 实时预测，反推到/离站时刻
  - [x] 路况/速度：由形状里程 + ETA 差分算平均速度；叠加 data.gov.hk 路况源（IRN 分段速度 + 原始探测器 rawSpeedVol-all.xml（可选）、JTI 走廊旅时；TDAS 暂不采集）
- [x] 编写“下载器”脚本（只做抓取与落盘，不做复杂逻辑）
  - [x] 拉取静态 route/stop/route-stop、GeoJSON 形状；ETA 定时采集（60s）
  - [x] 原始响应落 `data/raw/`（按 `线路-方向-日期-时段.json` 命名），记录请求参数/返回码/限流
- [x] 编写“清洗器”脚本（输出结构化真值）
  - [x] 站点序列/里程：`scripts/clean_kmb_shapes.py` 生成 `data/processed/kmb_route_stop_dist.csv`
  - [x] 站点层：`station_eta.csv`（统一时区/格式、去重、补缺）
  - [x] 路段层：`link_times.csv`、`link_speeds.csv`（站间运行时间/平均速度，含异常剔除/重采样/平滑可选）
  - [x] 可选：合并路况/事件/天气特征，输出到 `data/processed/`（CSV/Parquet）

### 5）定义 Week 1 的“对齐指标”（为 Week 2 校准做准备）
- [x] L1（站点层）目标量定义
  - [x] `T_arrive(i)`, `T_depart(i)`, `T_dwell(i)`, `T_link(i→i+1)`
  - [x] 初版误差：站点过站时间 RMSE（明确对齐到哪个站点集合/时间窗）
- [x] L2（路段层）目标量定义
  - [x] 路段速度分布/分位数（如 P10/P50/P90）与时变均值
  - [x] 初版距离度量：KS 统计量/EMD（二选一，先能算出来）

### 6）本周产出物（Definition of Done）
- [x] 一个能复现的 SUMO 场景：路网 + 站点 + 线路 + 配置，可一键运行
- [x] 一套可复现的数据管线：高德原始数据落盘 + 清洗后真值文件
- [x] 一个基线对比脚本：同一时段下输出“站点层误差 + 路段速度分布对比”
- [x] 一页问题清单：数据缺失/接口限制/地图匹配难点/后续风险与应对

---

## Week 2（L1 最小闭环：框架跑通）
### 1）高精度路网重建与修复（Network Repair）- [COMPLETED]
- [x] **路网转换**：利用 `RdNet_IRNP.gdb` (IRN) 替换 OSM 路网，解决站点缺失。
- [x] **连通性修复（Critical）**：
  - [x] 分析 Baseline 仿真日志，提取断裂边（"No connection" warnings）。
  - [x] 优化 `convert_irn_to_sumo_xml.py` 的 TURN 表解析，或手动编写 `fixed_connections.con.xml`。
  - [x] 验证 Route 68X/960 的端到端连通性（Teleport 归零）。

### 2）L1 微观参数定义与空间构建
- [x] **L1 微观参数定义与空间构建**
  - [x] `t_board` (上车时间): 影响停站时长，核心校准对象。
  - [x] `tau` (驾驶员反应时间): Krauss 跟驰模型。
  - [x] `sigma` (驾驶不完美度): 模拟随机减速。
  - [x] `minGap` (最小跟车距离): 影响停车排队密度。
  - [x] `accel` (最大加速度): 影响起步动力性能。
  - [x] `decel` (最大减速度): 影响制动减速性能。
  - [x] **参数范围表**：根据文献与经验设定上下限（如 $t_{board} \in [0.5, 5.0]s$）。
  - [x] **采样策略**：实现拉丁超立方采样 (LHS) 生成初始样本集 (e.g., N=15-20)。

### 3）L1 校准闭环构建 (MVC Loop)
- [x] **单一代理模型 (Surrogate)**：先实现 Kriging (Gaussian Process) 模型，跑通全流程。
- [x] **采集函数 (Acquisition)**：实现 Expected Improvement (EI) 策略。
- [x] **基础目标函数 ($J_1$)**：定义 RMSE (站点到/离站时刻)。
- [x] **自动化流程脚本**：
  - [x] 实现 `Gen Params` -> `Run SUMO` -> `Parse Output` -> `Update Surrogate` -> `Next Param` 的自动迭代。

### 4）基线与首轮校准运行
- [x] **基线运行 (B1)**：使用默认参数运行，记录各项指标作为对照。
- [x] **MVC 迭代**：运行 20-30 次迭代，验证 BO 搜索是否能有效降低 $J_1$。
- [x] **结果可视化**：绘制收敛曲线（Iteration vs. $J_1$）及初步轨迹对比图。

## Week 3（L1 完善：双代理与鲁棒性）
### 1）多代理模型融合 (Dual Surrogates)
- [x] **模型增强**：实现 RBF (Radial Basis Function) 插值模型（高斯核，epsilon 自动计算）。
- [x] **融合接口**：实现双代理融合（反比方差加权策略），提升全局与局部拟合精度。

### 2）鲁棒性目标函数升级
- [x] **分布损失**：在 $J_1$ 中引入 K-S 统计量和 Wasserstein 距离，对齐停站/站间时间分布。
- [x] **综合目标**：实现 $J = \text{mean}(E) + \lambda \cdot \text{std}(E)$ 和分位数损失（P90）以增强参数跨时段的鲁棒性。

### 3）B3 Baseline 运行与验证
- [x] **B3 运行**：使用双代理 (Kriging+RBF) + 单层 $J_1$ 在当前数据集上运行校准。
- [x] **结果对比**：与 B1（默认参数）、B2（单代理 Kriging）对比收敛曲线和最终 RMSE。

### 4）跨日验证（待 Week 4 完成后执行）
> **依赖**：需完整双层流程（双代理 + 双层 $J_1+J_2$）构建完成后进行。

- [ ] **新数据收集**：周一 (12/22) 17:00–18:00 收集新测试数据集 D2。
- [ ] **跨日测试**：分别在 D1 (12/17) 和 D2 (12/22) 上优化，对比泛化能力。

## Week 4（L2 同化：宏观拥堵融合 - IES 进阶版）

**目标**：利用迭代式系综平滑（Iterative Ensemble Smoother, IES）算法，校准宏观路网参数，使背景交通流产生的拥堵形态与真实世界一致。

### Step 1: 物理冻结与状态向量定义 (Freeze & Define) - [COMPLETED]
- [x] [cite_start]**1.1 锁定 L1 微观参数 (The "Certified" Bus)** [cite: 17, 25, 46]
    - [x] 使用 **B2 校准结果** 创建 `config/calibration/best_l1_parameters.json`（Iter 24, 68X RMSE=148.20）。
    - [x] **强制约束**：公交车参数 (`t_board=1.27`, `tau=1.06`, `accel=1.50`, `decel=3.83`) 已锁定。
    - [x] **严禁**将这些 L1 参数加入 L2 的优化变量中，确保微观物理一致性。

- [x] [cite_start]**1.2 定义 L2 状态向量 ($X$) 与先验分布** [cite: 33, 34, 35]
    - [x] 确定待校准宏观参数及其初始高斯分布 $X \sim \mathcal{N}(\mu, P)$：
        - **`capacityFactor` (Global)**: $\mu=1.0, \sigma=0.15$ (范围 $[0.5, 1.2]$)。控制全网流量瓶颈。
        - **`minGap` (Background)**: $\mu=2.5, \sigma=0.5$ (范围 $[1.0, 4.0]$)。控制拥堵时的排队密度。
        - **`impatience` (Background)**: $\mu=0.5, \sigma=0.2$ (范围 $[0.0, 1.0]$)。控制拥堵时的变道积极性。
    - [x] 编写 `config/calibration/l2_priors.json` 存储这些均值和方差。

### Step 2: 观测向量构建 (Observation Construction) - [COMPLETED]
- [x] [cite_start]**2.1 建立"高置信度"观测向量 ($Y_{obs}$)** [cite: 23, 24, 36]
    - [x] 输入：`enriched_link_stats.csv` (17:00-18:00 真值)。
    - [x] **筛选逻辑**（已调整阈值适应当前数据集）：
        1.  仅选取 **Main Corridor** (68X/960 沿线) 的路段。
        2.  剔除样本量 $N < 2$ 的噪声路段（原 N<10，因数据集最大样本量仅 7）。
        3.  剔除长度 $< 50m$ 的短路段（仿真误差大）。
    - [x] **输出**：`data/calibration/l2_observation_vector.csv`，包含 **M=45** 个路段（68X:21, 960:24）。

- [x] [cite_start]**2.2 构建观测算子 ($H(x)$)** [cite: 36, 47]
    - [x] 创建 `scripts/calibration/parse_edgedata_output.py`：解析 SUMO 的 `edgedata.out.xml`。
    - [x] 实现映射逻辑：按 `l2_observation_vector.csv` 中的路段顺序提取仿真速度（路段-边映射待完善）。

### Step 3: 迭代式系综平滑循环 (The IES Loop) - [COMPLETED]
> **核心脚本**: `scripts/calibration/run_ies_loop.py`
> **逻辑**: 批量仿真 $\rightarrow$ 计算协方差 $\rightarrow$ 更新参数分布 $\rightarrow$ 下一轮批量。

- [x] **3.1 初始化 (Initialization)**
    - [x] 设定系综规模 $N = 20$ (即每轮并行跑 20 个仿真)。
    - [x] 设定最大迭代轮数 $K = 5$ (IES 收敛较快，3-5 轮通常足够)。

- [x] [cite_start]**3.2 系综生成 (Ensemble Generation - The "Predict" Step)** [cite: 36, 41]
    - [x] 利用当前参数分布 $\mathcal{N}(\mu_k, P_k)$，使用 `numpy.random.multivariate_normal` 采样生成 $N$ 组参数向量 $\{X_1, X_2, ..., X_N\}$。
    - [x] 将这 $N$ 组参数分别写入 $N$ 个独立的配置文件（如 `run_0.sumocfg`, `run_1.sumocfg`...），对应修改 `capacityFactor` 等宏观变量。

- [x] [cite_start]**3.3 并行批量仿真 (Batch Simulation)** [cite: 18, 50]
    - [x] 利用 `multiprocessing` 或 `subprocess` 并行启动 $N$ 个 SUMO 实例。
    - [x] 每个实例运行完整的 1 小时（3600s），以获取稳定的宏观流体状态。
    - [x] **关键**：等待所有 $N$ 个进程全部结束 (Join)。

- [x] [cite_start]**3.4 状态收集与残差计算** [cite: 30, 36]
    - [x] 收集 $N$ 个结果向量 $Y_{sim, 1}...Y_{sim, N}$。
    - [x] 计算每个样本的残差：$E_i = Y_{obs} - Y_{sim, i}$。
    - [x] 计算整体 RMSE 和 K-S 距离作为本轮收敛判据。

- [x] [cite_start]**3.5 IES 更新步 (The Update Analysis)** [cite: 36, 47]
    - [x] **计算协方差矩阵**：
        - $C_{xf}$：参数 $X$ 与模型预测 $Y_{sim}$ 之间的互协方差。
        - $C_{ff}$：模型预测 $Y_{sim}$ 的自协方差。
    - [x] **计算卡尔曼增益 ($K$)**：
        - $K = C_{xf} (C_{ff} + R)^{-1}$ （其中 $R$ 是观测噪声矩阵，可设为对角阵，值取观测方差）。
    - [x] **更新参数分布**：
        - 利用公式更新参数均值：$\mu_{new} = \mu_{old} + K(Y_{obs} - \bar{Y}_{sim})$。
        - (*进阶可选*) 收缩参数方差 $P$ 以聚焦搜索范围。
    - [x] **日志记录**：将本轮的 $\mu_{new}$ 和 RMSE 写入 `data/calibration/B4_ies_log.csv`。

### Step 4: 结果验证与可视化 (Validation) - [COMPLETED]
- [x] **4.1 最优解确认**
    - [x] 从最后一轮 IES 中选取误差最小的那一组参数作为最终 $\theta_{L2}$。
    - [x] 更新 `config/calibration/final_simulation_parameters.json` (合并 L1+L2)。

- [x] [cite_start]**4.2 时空图物理验证 (Physics Check)** [cite: 38]
    - [x] 运行 `plot_spacetime.py`。
    - [x] **Checklist**:
        - [x] 是否在真实拥堵位置（如美孚转盘、红隧入口）复现了“深色拥堵带”？
        - [x] 拥堵带的“消散时间”是否与现实接近？

- [x] [cite_start]**4.3 统计分布检验** [cite: 19, 38]
    - [x] 运行 `verify_distribution.py`。
    - [x] 绘制全路网速度的 CDF (累积分布函数) 对比图。
    - [x] 计算 K-S 统计量 ($D_{KS}$)，目标是 $D_{KS} < 0.15$ 或 p-value $> 0.05$ (无法拒绝同分布假设)。
    - [ ] **优化方向**：
        - [ ] 考虑增加系综规模 (N=15~20) 以提高协方差估计稳定性
        - [ ] 改进链路-边映射精度（引入距离加权平均）

---

## 核心问题诊断与改进路线图（Week 4.5 专项）

> **背景**：基于 B1-B4 实验结果的深度分析，本节总结核心问题并给出可执行的改进方案。

### 一、B1-B4 实验结果诊断总结

#### B1：默认参数（暴露结构性问题）
| 指标 | 68X | 960 | 结论 |
|------|-----|-----|------|
| 端到端时间 (仿真) | 2255.8s | - | 误差 **-74.8%（严重过快）** |
| 端到端时间 (真实) | 8962.4s | - | 960 误差仅 -6.2% |

**诊断**：
- 同一套默认参数，960 能对、68X 崩 → **问题主要来自"路网/背景拥堵/信号/需求"在 68X 走廊上的结构性缺失**，而非微观参数偏差。
- 真实速度大量接近 0、仿真速度集中在 40–50 → **B1 在宏观拥堵形态上没长出来**（缺乏真实的排队、溢出、停走纹理）。

#### B2：单代理 Kriging + 单层 J1（L1 微观校准天花板）
| 指标 | 68X | 960 | 备注 |
|------|-----|-----|------|
| RMSE (最优) | **148.20s** | 329.64s | Iter=24, 约束阈值 350 |

**诊断**：
- ✅ **BO + Kriging 有效**：在"公交自身行为"层面把误差压下来了。
- ⚠️ **但只能解决 J1（站点/线路层）**：后验验证的硬伤——速度分布缺少 0 速、车头时距尖峰、链路速度方差几乎为 0——都说明 **"只调公交车"无法凭空制造真实拥堵**。
- 📌 **结论**：B2 很可能已接近"L1 能达到的天花板"。

#### B3：Kriging+RBF 融合 + 单层 J1（消融实验）
| 指标 | 数值 | 备注 |
|------|------|------|
| Combined Loss (最优) | 158.37 | Iter=32, 略差于 B2 |
| 约束满足率 | 62.5% | 8 次里 5 次满足 |

**诊断**：
- 7 维 L1 参数空间很"平滑"，单一 Kriging 已够拟合。
- 融合可能因"误导的不确定性/拟合偏置"让 EI 采样更爱乱跳。
- 📌 **结论**：复杂代理不带来收益（支撑选 B2 作为主方法）。

#### B4：IES 双层同化（结构缺口补救）
| 指标 | B4_v2 | B4_v3 | 备注 |
|------|-------|-------|------|
| RMSE | 22.95 km/h | - | 仿真成功率 100% |
| K-S | 0.56 | 0.56 | 分布差异仍显著 |

**诊断**：
- ✅ **方向对了**：终于在补"结构缺口"（拥堵/速度分布）。
- ⚠️ **同化不稳 + 参数打边界**：
  - `obs_noise_std` 太小 → 增益过大 → 参数踹到边界。
  - 固定 `seed=42` → 系综样本信息量无增加。
  - 最优参数极端值（`capacityFactor=1.5`, `minGap=0.5m`, `impatience=1.0`）→ 模型在"替缺失机制硬补"。

---

### 二、验证图诊断（4 张关键图的物理含义）

#### (a)(b) 速度分布：真值 0–20 为主，仿真 40–60 为主
- **含义**：交通状态分区完全不同——真值在拥堵态，仿真在自由流态。
- **红灯**：$N_{real}=45$ vs $N_{sim}=6398$ → **统计口径不一致**（路段聚合 vs 原始样本）。

#### (c) 时空图：真值断裂低速，仿真平滑高速
- **含义**：仿真缺少"红灯截断 + 排队溢出 + 慢车阻塞"的**纹理生成机制**。

#### (d) Link 箱线图：Link 5/6 灾区
- **含义**：需要**局部瓶颈/局部摩擦**，而非全局一刀切。

#### (e) Headway：真值 0s 密度高 + 长尾，仿真尖峰
- **含义**：需要**发车扰动 + 停站随机化**。

---

### 三、三条主线改进方向

#### 主线 1：系统缺乏随机扰动源与外部拥堵驱动

**立刻可做（不改框架，只改建模）**：

| 改进项 | 具体做法 | 预期效果 |
|--------|----------|----------|
| 发车/注入间隔随机化 | 在计划班次上叠加噪声（正态/对数正态，$\pm 30-90s$） | Headway 分布打散尖峰 |
| 停站时长用分布 | 在物理一致性模型上加噪声：$T_{dwell} \sim \mathcal{N}(T_{fixed} + t_{board} \times W_{stop}, \sigma^2)$ | 增加 0 速与停走纹理 |
| 背景车异质性 | `speedFactor`/`tau` 做分布而非定值 | 时空图出现"有纹理的带状" |
| 局部瓶颈 | 为 Top-K 拥堵 link 引入 `speedLimitFactor_i` (3-5 个) | 箱线图低速段对齐 |

> ⚠️ **注意**：随机性要"加在现有的物理一致性停站模型上"，而不是回退到"随机乘客数把一切打散"。

#### 主线 2：B4 做成"真正的双层目标"

- [x] **锁定 B2 的 L1 参数**：严禁把 L1 放进 L2 优化变量（已完成）。
- [ ] **目标函数升级**：从"只看均值 RMSE"升级为 **RMSE + 分布项（K-S/EMD）**。
- [ ] **论文叙事**：B2 负责"公交物理"，B4 负责"宏观拥堵形态"。

#### 主线 3：让 IES 收敛稳定

| 问题 | 解决方案 |
|------|----------|
| 固定 seed 导致系综信息不变 | 每个 ensemble member 用不同随机种子 |
| N=8 协方差估计不稳 | 提升到 N=15–20 |
| 链路-边映射残余误差 | 改进映射精度（引入距离加权平均） |
| 参数打边界（红灯！） | 缩小先验边界 或 分区/走廊局部参数化 |

---

### 四、验证口径统一（**最高优先级**）

> ⚠️ **在继续任何调参之前，必须先完成此步！**

**当前问题**：
- 观测向量 $Y_{obs}$：45 个路段的聚合均值
- 仿真向量 $Y_{sim}$：数千条原始速度记录（每车×每边×时间片）
- → CDF/直方图/KS 结论被"口径不一致"放大

**解决方案**：
- [x] **Step 0**：把 Sim 也压成 **45 维**，每一维与观测完全同口径：
  - 同一时间窗（17:00–18:00）
  - 同一条 link→edge 映射
  - 同一聚合方式（**旅行时间加权调和平均**：$v_{link} = \frac{\sum L_i}{\sum \frac{L_i}{v_i}}$）
  - 同一过滤规则（`sampledSeconds ≥ 10s`，排除 internal edges）
  - **实现**：`scripts/calibration/build_l2_simulation_vector.py`
  - **修改**：`run_ies_loop.py` 使用新函数 + matched_mask 掩码

---

### 五、最小闭环实验顺序（不绕路）

```
1. [x] 固定 B2 的 L1（Certified Bus） → 只动 L2
2. [x] 统一验证口径：Sim 聚合到 45 维（与 Y_obs 同口径）
3. [ ] 用 B4_v2 参数跑"时空图/链路箱线图/速度分布/Headway分布"验证
4. [ ] 若仍出现"0速不足 + headway尖峰"：
   → 优先加"发车扰动 + 停站随机化"（最便宜、最直接生成纹理）
5. [ ] capacityFactor 方向验证：固定其它参数，0.5→1.5 看速度升降
6. [ ] 局部瓶颈参数化：为 Link 5/6 等灾区引入专属摩擦旋钮
7. [ ] 最后再谈"更复杂代理/更复杂优化"（B3 已证明：代理复杂化不是瓶颈）
```

---

### 六、KPI 目标设定（工程可信）

| 指标 | 当前值 | 阶段目标 | 最终目标 |
|------|--------|----------|----------|
| K-S (速度分布) | 0.56 | 0.40 | 0.30 |
| RMSE (路段速度) | 22.95 km/h | 15 km/h | 10 km/h |
| 0 速比例 (仿真) | ~0% | >5% | 接近真值 |
| Headway 分布匹配 | 尖峰 | 打散 | K-S <0.3 |

---

## Week 5（评估：鲁棒性与泛化）
- [ ] K-S 检验（95%）：速度分布同源性结论
- [ ] 不同拥堵情景/不同日期迁移测试
- [ ] 敏感性分析：关键参数扰动对指标影响

## Week 6（写作与交付）
- [ ] 方法章节：问题定义、两层参数、代理模型、BO、EnKF
- [ ] 实验章节：数据描述、场景、对比基线、结果图表、讨论
- [ ] 代码与复现说明：运行步骤、配置文件、随机种子、数据目录说明
- [ ] 论文大纲初稿（参见 `docs/paper_outline.md`，ICTLE 6–8 页结构）
